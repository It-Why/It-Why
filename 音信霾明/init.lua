--Voice
uart.setup(0,9600,8,0,1,0)
uart.write(0,0xFD,0x00,0x19,0x01,0x79,0x5B,0x62,0x30,0x5D,0xA1,0xA3,0xBB,0xB6,0xD3,0xAD,0xCA,0xB9,0xD3,0xC3,0xD2,0xF4,0xD0,0xC5,0xF6,0xB2,0xC3,0xF7,0x99)
tmr.delay(5000000)
--Ws2812
ws=1
ws2812.init()
i,buffer=0,ws2812.newBuffer(30,3)
buffer:fill(0,0,0)
r=255
b=0
g=255
tmr.alarm(0,50,1,function()
    if (ws==1) then
        i = i + 1
        buffer:fade(2)
        buffer:set(i%buffer:size()+1,g,r,b)
        r=r-4
        b=b+8
        g=g-8
    elseif (ws==2) then
        buffer:fill(250, 0, 0)
    elseif (ws==3) then
        buffer:fill(80, 40, 0)
    elseif (ws==4) then
        buffer:fill(20, 50, 15)
    elseif (ws==5) then
        buffer:fill(0,70,35)
    elseif (ws==6) then
        buffer:fill(0, 250, 40)
    elseif (ws==7) then
        buffer:fill(0, 250, 0)
    end
    ws2812.write(buffer)
end)
tmr.delay(10000000)
-- Pm2.5
pm25=100
pu=0
du=0
gpio.mode(5,gpio.INT)
gpio.trig(5,"both",function(level)
    if level == gpio.LOW then
        pu=tmr.now()
    else
        du=du+tmr.now()-pu
    end
end)
tmr.alarm(1,30000,1,function()
    ra = du/30000
    du=0
    co=1.1*ra*ra*ra-3.8*ra*ra+520*ra+0.62
    pm25=0.02*co
    if (pm25<=50) then
        ws=2
    elseif (pm25<=100) then
        ws=3
    elseif (pm25<=150) then
        ws=4
    elseif (pm25<=200) then
        ws=5
    elseif (pm25<=300) then
        ws=6
    elseif (pm25>300) then
        ws=7
    end
end)
-- DHT
dhtzt,wd,sd,wddec,sddec=dht.read11(1)
tmr.alarm(2,10000,1,function()
    dhtzt,wd,sd,wddec,sddec=dht.read11(1)
end)
-- Wifi
wifi.setmode(wifi.STATIONAP)
apcfg={}
apcfg.ssid='nodemcu'
apcfg.pwd='cuitcdio'
wifi.ap.config(apcfg)
wifi.sta.config("CDIO","cuitcdio")
wifi.sta.connect()
-- Time
function refreshTime()
    time = rtctime.epoch2cal(rtctime.get())
    print(string.format("%02d:%02d", time["hour"] + 8, time["min"]))
end
sntp.sync("202.120.2.101", function() tmr.alarm(3, 60000, 1, refreshTime() ) end ) end
-- Button
gpio.trig(2,"up",function(level)
    if level == gpio.HIGH then
        if (ws==2) then
            uart.write(0,0xFD,0x00,0x18,0x01,0x79,0x5B,0x6D,0x31,0x30,0x5D,0xB5,0xB1,0xC7,0xB0,0xBF,0xD5,0xC6,0xF8,0xD6,0xCA,0xC1,0xBF,0xCE,0xAA,0xD3,0xC5,0xC0)
        elseif (ws==3) then
            uart.write(0,0xfd,0x00,0x13,0x01,0x61,0xb5,0xb1,0xc7,0xb0,0xbf,0xd5,0xc6,0xf8,0xd6,0xca,0xc1,0xbf,0xce,0xaa,0xc1,0xbc,0xd2)
        elseif (ws==4) then
            uart.write(0,0xfd,0x00,0x21,0x01,0x31,0x5b,0x62,0x30,0x5d,0xa1,0xa3,0xb5,0xb1,0xc7,0xb0,0xbf,0xd5,0xc6,0xf8,0xd6,0xca,0xc1,0xbf,0xce,0xaa,0xc7,0xe1,0xb6,0xc8,0xce,0xdb,0xc8,0xbe,0xa1,0xa3,0xa2)
        elseif (ws==5) then
            uart.write(0,0xfd,0x00,0x21,0x01,0x71,0x5b,0x62,0x30,0x5d,0xa1,0xa3,0xb5,0xb1,0xc7,0xb0,0xbf,0xd5,0xc6,0xf8,0xd6,0xca,0xc1,0xbf,0xce,0xaa,0xd6,0xd0,0xb6,0xc8,0xce,0xdb,0xc8,0xbe,0xa1,0xa3,0xc2)
        elseif (ws==6) then
            uart.write(0,0xfd,0x00,0x21,0x01,0x41,0x5b,0x62,0x30,0x5d,0xa1,0xa3,0xb5,0xb1,0xc7,0xb0,0xbf,0xd5,0xc6,0xf8,0xd6,0xca,0xc1,0xbf,0xce,0xaa,0xd6,0xd8,0xb6,0xc8,0xce,0xdb,0xc8,0xbe,0xa1,0xa3,0xfa)
        elseif (ws==7) then
            uart.write(0,0xfd,0x00,0x21,0x01,0x69,0x5b,0x62,0x30,0x5d,0xa1,0xa3,0xb5,0xb1,0xc7,0xb0,0xbf,0xd5,0xc6,0xf8,0xd6,0xca,0xc1,0xbf,0xce,0xaa,0xd1,0xcf,0xd6,0xd8,0xce,0xdb,0xc8,0xbe,0xa1,0xa3,0xb2)
        end
    end
end)
-- Web
srv=net.createServer(net.TCP)
srv:listen(80,function(conn)
  conn:on("receive",function(conn,payload)
    print(payload)  
        local html = string.format("HTTP/1.0 200 OK\r\n"  
        .."Content-Type: text/html\r\n"
        .."Connection: Close\r\n\r\n"
        .."<title>音信霾明</title>"
        .."<h1>欢迎使用音信霾明</h1>"
        .."<h2>当前温度"..wd.."</h2>"
        .."<h2>当前湿度"..sd.."</h2>"
        .."<h2>当前Pm2.5值"..pm25.."</h2>"
        .."<p>By:张金花、曹利芳、杨玲、王和远、姚堃</p>"
        )
    conn:send(html)
  end)
  conn:on("sent",function(conn) conn:close() end)
end)
