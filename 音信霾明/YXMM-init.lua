--[[

--]]
uart.setup(0,9600,8,0,1,0)
tmr.delay(5000000)
--Voice
uart.write(0,0xFD,0x00,0x18,0x01,0x01,0x72,0x69,0x6E,0x67,0x6B,0xBB,0xB6,0xD3,0xAD,0xCA,0xB9,0xD3,0xC3,0xD2,0xF4,0xD0,0xC5,0xF6,0xB2,0xC3,0xF7,0xCF)
--Ws2812
ws=0
ws2812.init()
i,buffer=0,ws2812.newBuffer(30,3);
buffer:fill(0,0,0);
r=255
b=0
g=255
tmr.alarm(0,50,1,function()
	if (ws==0) then
		i=i+1
		buffer:fade(2)
		buffer:set(i%buffer:size()+1,g,r,b)
		r=r-4
		b=b+8
		g=g-8
	elseif (ws==1) then
		buffer:fill(250,0,0)
	elseif (ws==2) then
		buffer:fill(80,40,0)
	elseif (ws==3) then
		buffer:fill(20,50,15)
	elseif (ws==4) then
		buffer:fill(0,70,35)
	elseif (ws==5) then
		buffer:fill(0,250,40)
	elseif (ws==6) then
		buffer:fill(0,250,0)
	end
	ws2812.write(buffer)
end)
tmr.delay(10000000)
-- Pm2.5
pm25=100
pu=0
du=0
gpio.mode(5,gpio.INT)
gpio.trig(5,"both",function(level)
	if level == gpio.LOW then
		pu=tmr.now()
	else
		du=du+tmr.now()-pu
	end
end)
tmr.alarm(1,30000,1,function()
	ra=du/300000
	du=0
	co=1.1*ra*ra*ra-3.8*ra*ra+520*ra+0.62
	pm25=co/50
	if (pm25<=50) then
		ws=1
	elseif (pm25<=100) then
		ws=2
	elseif (pm25<=150) then
		ws=3
	elseif (pm25<=200) then
		ws=4
	elseif (pm25<=300) then
		ws=5
	elseif (pm25>300) then
		ws=6
	end
end)
-- DHT
dhtzt,wd,sd,wddec,sddec=dht.read11(1)
tmr.alarm(2,10000,1,function()
	dhtzt,wd,sd,wddec,sddec=dht.read11(1)
end)
-- Wifi
wifi.setmode(wifi.STATIONAP)
apcfg={}
apcfg.ssid='nodemcu'
apcfg.pwd='cuitcdio'
wifi.ap.config(apcfg)
wifi.sta.config("king1","cuitcdio")
wifi.sta.connect()
-- Button
gpio.mode(2,gpio.INT)
gpio.trig(2,"up",function(level)
	if level == gpio.HIGH then
		uart.write(0,0xfd,0x00,0x23,0x01)
		if (ws==1) then
			uart.write(0,0x79,0xbf,0xd5,0xc6,0xf8,0xd6,0xca,0xc1,0xbf,0xce,0xaa,0xd3,0xc5,0x20,0x20,0x20,0x20,0x20,0x20,0x2c,0xce,0xc2,0xb6,0xc8,48+math.floor(wd/10),48+math.floor(wd%10),0x2c,0xca,0xaa,0xb6,0xc8,48+math.floor(sd/10),48+math.floor(sd%10))
			yh=0x8e
			yh=bit.bxor(yh,48+math.floor(wd/10),48+math.floor(wd%10),48+math.floor(sd/10),48+math.floor(sd%10))
			uart.write(0,yh)
		elseif (ws==2) then
			uart.write(0,0x61,0xbf,0xd5,0xc6,0xf8,0xd6,0xca,0xc1,0xbf,0xce,0xaa,0xc1,0xbc,0x20,0x20,0x20,0x20,0x20,0x20,0x2c,0xce,0xc2,0xb6,0xc8,48+math.floor(wd/10),48+math.floor(wd%10),0x2c,0xca,0xaa,0xb6,0xc8,48+math.floor(sd/10),48+math.floor(sd%10))
			yh=0xfd
			yh=bit.bxor(yh,48+math.floor(wd/10),48+math.floor(wd%10),48+math.floor(sd/10),48+math.floor(sd%10))
			uart.write(0,yh)
		elseif (ws==3) then
			uart.write(0,0x31,0xbf,0xd5,0xc6,0xf8,0xd6,0xca,0xc1,0xbf,0xce,0xaa,0xc7,0xe1,0xb6,0xc8,0xce,0xdb,0xc8,0xbe,0x2c,0xce,0xc2,0xb6,0xc8,48+math.floor(wd/10),48+math.floor(wd%10),0x2c,0xca,0xaa,0xb6,0xc8,48+math.floor(sd/10),48+math.floor(sd%10))
			yh=0xeb
			yh=bit.bxor(yh,48+math.floor(wd/10),48+math.floor(wd%10),48+math.floor(sd/10),48+math.floor(sd%10))
			uart.write(0,yh)
		elseif (ws==4) then
			uart.write(0,0x71,0xbf,0xd5,0xc6,0xf8,0xd6,0xca,0xc1,0xbf,0xce,0xaa,0xd6,0xd0,0xb6,0xc8,0xce,0xdb,0xc8,0xbe,0x2c,0xce,0xc2,0xb6,0xc8,48+math.floor(wd/10),48+math.floor(wd%10),0x2c,0xca,0xaa,0xb6,0xc8,48+math.floor(sd/10),48+math.floor(sd%10))
			yh=0x8b
			yh=bit.bxor(yh,48+math.floor(wd/10),48+math.floor(wd%10),48+math.floor(sd/10),48+math.floor(sd%10))
			uart.write(0,yh)
		elseif (ws==5) then
			uart.write(0,0x41,0xbf,0xd5,0xc6,0xf8,0xd6,0xca,0xc1,0xbf,0xce,0xaa,0xd6,0xd8,0xb6,0xc8,0xce,0xdb,0xc8,0xbe,0x2c,0xce,0xc2,0xb6,0xc8,48+math.floor(wd/10),48+math.floor(wd%10),0x2c,0xca,0xaa,0xb6,0xc8,48+math.floor(sd/10),48+math.floor(sd%10))
			yh=0xb3
			yh=bit.bxor(yh,48+math.floor(wd/10),48+math.floor(wd%10),48+math.floor(sd/10),48+math.floor(sd%10))
			uart.write(0,yh)
		elseif (ws==6) then
			uart.write(0,0x69,0xbf,0xd5,0xc6,0xf8,0xd6,0xca,0xc1,0xbf,0xce,0xaa,0xd1,0xcf,0xd6,0xd8,0xce,0xdb,0xc8,0xbe,0x2c,0xce,0xc2,0xb6,0xc8,48+math.floor(wd/10),48+math.floor(wd%10),0x2c,0xca,0xaa,0xb6,0xc8,48+math.floor(sd/10),48+math.floor(sd%10))
			yh=0xfb
			yh=bit.bxor(yh,48+math.floor(wd/10),48+math.floor(wd%10),48+math.floor(sd/10),48+math.floor(sd%10))
			uart.write(0,yh)
		end
	end
end)
gpio.mode(3,gpio.INT)
gpio.trig(3,"up",function(level)
	if level == gpio.HIGH then
		ws=ws+1
		ws=ws%7
	end
end)
mu=0
gpio.mode(7,gpio.INT)
gpio.trig(7,"up",function(level)
	if level == gpio.HIGH then
		if (mu==0) then
			uart.write(0,0xfd,0x00,0x08,0x01,0x01,0x72,0x69,0x6e,0x67,0x61,0x86)
		elseif (mu==1) then
			uart.write(0,0xfd,0x00,0x08,0x01,0x01,0x72,0x69,0x6e,0x67,0x62,0x85)    
		elseif (mu==2) then
			uart.write(0,0xfd,0x00,0x08,0x01,0x01,0x72,0x69,0x6e,0x67,0x63,0x84)
		elseif (mu==3) then
			uart.write(0,0xfd,0x00,0x08,0x01,0x01,0x72,0x69,0x6e,0x67,0x64,0x83)
		elseif (mu==4) then
			uart.write(0,0xfd,0x00,0x08,0x01,0x01,0x72,0x69,0x6e,0x67,0x65,0x82)
		elseif (mu==5) then
			uart.write(0,0xfd,0x00,0x08,0x01,0x01,0x72,0x69,0x6e,0x67,0x66,0x81)
		elseif (mu==6) then
			uart.write(0,0xfd,0x00,0x08,0x01,0x01,0x72,0x69,0x6e,0x67,0x67,0x80)
		elseif (mu==7) then
			uart.write(0,0xfd,0x00,0x08,0x01,0x01,0x72,0x69,0x6e,0x67,0x68,0x8f)
		elseif (mu==8) then
			uart.write(0,0xfd,0x00,0x08,0x01,0x01,0x72,0x69,0x6e,0x67,0x69,0x8e)
		elseif (mu==9) then
			uart.write(0,0xfd,0x00,0x08,0x01,0x01,0x72,0x69,0x6e,0x67,0x6a,0x8d)
		elseif (mu==10) then
			uart.write(0,0xfd,0x00,0x08,0x01,0x01,0x72,0x69,0x6e,0x67,0x6b,0x8c)
		elseif (mu==11) then
			uart.write(0,0xfd,0x00,0x08,0x01,0x01,0x72,0x69,0x6e,0x67,0x6c,0x8b)
		elseif (mu==12) then
			uart.write(0,0xfd,0x00,0x08,0x01,0x01,0x72,0x69,0x6e,0x67,0x6d,0x8a)
		elseif (mu==13) then
			uart.write(0,0xfd,0x00,0x08,0x01,0x01,0x72,0x69,0x6e,0x67,0x6e,0x89)
		elseif (mu==14) then
			uart.write(0,0xfd,0x00,0x08,0x01,0x01,0x72,0x69,0x6e,0x67,0x6f,0x88)         
		end   
	end
	mu=mu+1
	mu=mu%15
end)
-- Web
srv=net.createServer(net.TCP)
srv:listen(80,function(conn)
	conn:on("receive",function(conn,payload)
		print(payload)  
		local html = string.format("HTTP/1.0 200 OK\r\n"  
		.."Content-Type: text/html\r\n"
		.."Connection: Close\r\n\r\n"
		.."<title>音信霾明</title>"
		.."<h1>欢迎使用音信霾明</h1>"
		.."<h2>当前温度"..wd.."</h2>"
		.."<h2>当前湿度"..sd.."</h2>"
		.."<h2>当前Pm2.5值"..pm25.."</h2>"
		.."<p>By:张金花、曹利芳、杨玲、王和远、姚堃</p>"
		)
		conn:send(html)
	end)
	conn:on("sent",function(conn) conn:close() end)
end)